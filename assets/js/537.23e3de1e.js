(window.webpackJsonp=window.webpackJsonp||[]).push([[537],{896:function(e,t,a){"use strict";a.r(t);var s=a(2),r=Object(s.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"synchronous-replication"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#synchronous-replication"}},[e._v("#")]),e._v(" Synchronous Replication")]),e._v(" "),a("WrappedSection",[a("h3",{attrs:{id:"synchronous-replication-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#synchronous-replication-2"}},[e._v("#")]),e._v(" Synchronous Replication")]),e._v(" "),a("p",[e._v("Replication is a common technique used in distributed databases to achieve scalable data distribution for better fault tolerance. Multiple replicas of a primary database server are created for higher durability. One of the replication methods is to update each replica as part of a single atomic transaction, also known as synchronous replication. Consensus algorithms apply this approach to achieve strong consistency on a replicated data set. Immudb now supports the option for synchronous replication.")]),e._v(" "),a("h3",{attrs:{id:"architecture"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#architecture"}},[e._v("#")]),e._v(" Architecture")]),e._v(" "),a("p",[e._v("In synchronous replication, each commit of a write transaction will wait until the confirmation that the commit has been committed to both the primary and quorum of replica server(s). This method minimizes the possibility of data loss.")]),e._v(" "),a("p",[e._v("ImmuDB uses a quorum-based technique to enforce consistent operation in a distributed cluster. A quorum of replicas is used to ensure that synchronous replication is achieved even when replication is not completed across all replica servers. A quorum is a majority of the number of replicas in a cluster setup. The quorum can be set when you create or update your database.")]),e._v(" "),a("p",[e._v("The primary server will wait for acknowledgment from a quorum of replica server(s) that each transaction is committed before proceeding. The drawback is that if enough replica server(s) go down or canâ€™t commit a transaction, and the quorum is not reached, the primary server goes into a hung state.")]),e._v(" "),a("p",[a("img",{attrs:{src:"/immudb/replication-sync.png",alt:"synchronous replication"}})]),e._v(" "),a("p",[e._v("Compare this to the asynchronous replication mode, the primary server does not need to wait for transaction-completion acknowledgment from the replica server. The replication transactions queue up on the replica server, and the two servers can remain out-of-sync for a specified time until the processing completes.")]),e._v(" "),a("p",[a("img",{attrs:{src:"/immudb/replication-async.png",alt:"asynchronous replication"}})]),e._v(" "),a("p",[e._v("ImmuDB provides support for synchronous replication by means of a follower approach. There are two grpc endpoint used for replication:")]),e._v(" "),a("ul",[a("li",[a("p",[a("code",[e._v("ExportTx")]),e._v(": Used by replicas to fetch precommitted transactions from the primary database server, and also to send the current database state to update the primary server.")])]),e._v(" "),a("li",[a("p",[a("code",[e._v("ReplicateTx")]),e._v(": Used by replicas to commit precommitted transactions (fetched from the primary) on the replica server.")])])]),e._v(" "),a("p",[e._v("The primary server keeps a record of the current state of each replica. The current state of each replica is updated through the "),a("code",[e._v("ExportTx")]),e._v(" grpc call from the replica server. So when a new transaction request comes to the primary server, it precommits the transaction, and checks if a quorum (on the transaction) has been reached by the replica server(s) by checking their state continously. If the quorum was reached, the transaction is marked as successful.")]),e._v(" "),a("div",{staticClass:"wrapped-picture"},[a("p",[a("img",{attrs:{src:"/immudb/replication-state.png",alt:"how synchronous replication works"}})])])]),e._v(" "),a("WrappedSection",[a("h3",{attrs:{id:"deciding-on-number-of-servers-in-a-cluster"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#deciding-on-number-of-servers-in-a-cluster"}},[e._v("#")]),e._v(" Deciding on number of servers in a cluster")]),e._v(" "),a("p",[e._v("Synchronous replication in a cluster can function only if the majority of servers are up and running. In systems doing data replication, it is important to consider the throughput of write operations. Every time data is written to the cluster, it needs to be copied to multiple replicas. Every additional server adds some overhead to complete this write. The latency of data write is directly proportional to the number of servers forming the quorum.")])]),e._v(" "),a("WrappedSection",[a("h3",{attrs:{id:"settings"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#settings"}},[e._v("#")]),e._v(" Settings")]),e._v(" "),a("p",[e._v("Synchronous replication is enabled per database. The following flags in the "),a("code",[e._v("immuadmin")]),e._v(" tool will help in setting up synchronous replication for your database.")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("Flags:\n      --replication-allow-tx-discarding              allow precommitted transactions to be discarded "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("if")]),e._v(" the follower diverges from the master\n      --replication-commit-concurrency uint32        "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("set")]),e._v(" the number of threads "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("for")]),e._v(" concurrent replication\n      --replication-follower-password string         "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("set")]),e._v(" password used "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("for")]),e._v(" replication\n      --replication-follower-username string         "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("set")]),e._v(" username used "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("for")]),e._v(" replication\n      --replication-is-replica                       "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("set")]),e._v(" database as a replica\n      --replication-master-address string            "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("set")]),e._v(" master address\n      --replication-master-database string           "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("set")]),e._v(" master database to be replicated\n      --replication-master-port uint32               "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("set")]),e._v(" master port\n      --replication-prefetch-tx-buffer-size uint32   maximum number of prefeched transactions "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("default "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("100")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n      --replication-sync-enabled                     "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("enable")]),e._v(" synchronous replication\n      --replication-sync-followers uint32            "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("set")]),e._v(" a minimum number of followers "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("for")]),e._v(" ack replication before transactions can be committed\n")])])])]),e._v(" "),a("WrappedSection",[a("h3",{attrs:{id:"setup"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#setup"}},[e._v("#")]),e._v(" Setup")]),e._v(" "),a("p",[e._v("This setup guides you through a simple demonstration of how synchronous replication works in ImmuDB. Starting with a 2-node local cluster, you'll write some data and verify that it replicates in sync.")]),e._v(" "),a("h4",{attrs:{id:"before-you-begin"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#before-you-begin"}},[e._v("#")]),e._v(" Before you begin")]),e._v(" "),a("p",[e._v("Make sure you already have "),a("RouterLink",{attrs:{to:"/master/running/download.html"}},[e._v("ImmuDB installed")]),e._v(".")],1),e._v(" "),a("blockquote",[a("p",[e._v("Since you're running a local cluster, all nodes use the same hostname ("),a("code",[e._v("localhost")]),e._v(").")])]),e._v(" "),a("h4",{attrs:{id:"step-1-start-the-cluster"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#step-1-start-the-cluster"}},[e._v("#")]),e._v(" Step 1. Start the cluster")]),e._v(" "),a("ol",[a("li",[a("p",[e._v("Run the primary server:")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$  ./immudb --dir data_master\n")])])])]),e._v(" "),a("li",[a("p",[e._v("In a new terminal, start replica server:")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$  ./immudb --dir data_follower "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n   --port"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("3324")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n   --pgsql-server"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("false "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n   --metrics-server"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("false\n")])])])]),e._v(" "),a("li",[a("p",[e._v("In a new terminal, use the "),a("RouterLink",{attrs:{to:"/master/connecting/clitools.html"}},[a("code",[e._v("immuadmin")])]),e._v(" command to create a database on the primary server:")],1),e._v(" "),a("p",[e._v("Login to immudb")]),e._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[e._v("$ /immuadmin login immudb\n")])])]),a("p",[e._v("Create a database "),a("code",[e._v("db")]),e._v(" that requires 1 confirmation from the synchronous followers to do the commit.")]),e._v(" "),a("blockquote",[a("p",[e._v("Note that "),a("code",[e._v("replication-sync-followers")]),e._v(" is not the number of existing followers, but the number of confirmations needed, which ideally should be set to "),a("code",[e._v("ceil(number of followers/2)")]),e._v(" to commit a transaction on the primary server.")])]),e._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[e._v("$ ./immuadmin database create primarydb "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n--replication-sync-followers "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n--replication-sync-enabled\n")])])]),a("p",[e._v("At this point, the "),a("code",[e._v("primarydb")]),e._v(" has been created on the primary server.")])]),e._v(" "),a("li",[a("p",[e._v("Use the "),a("RouterLink",{attrs:{to:"/master/connecting/clitools.html"}},[a("code",[e._v("immuadmin")])]),e._v(" command to create a database on the replica server:")],1),e._v(" "),a("p",[e._v("Login to immudb")]),e._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[e._v("$ /immuadmin login immudb -p "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("3324")]),e._v("\n")])])]),a("p",[e._v("Create a database "),a("code",[e._v("replicadb")]),e._v(" which will sync from the primary server's database "),a("code",[e._v("primarydb")])]),e._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[e._v("$ ./immuadmin database create replicadb -p "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("3324")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n--replication-enabled "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n--replication-master-address "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("127.0")]),e._v(".0.1 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n--replication-master-database primarydb "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n--replication-follower-username immudb "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n--replication-follower-password immudb "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n--replication-master-port "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("3322")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n--replication-sync-enabled "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n--replication-prefetch-tx-buffer-size "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("1000")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n--replication-commit-concurrency "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("100")]),e._v("\n")])])]),a("p",[e._v("At this point, the "),a("code",[e._v("replicadb")]),e._v(" has been created on the replica server to sync with the "),a("code",[e._v("primarydb")]),e._v(" on master server.")])])]),e._v(" "),a("h4",{attrs:{id:"step-2-send-a-request"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#step-2-send-a-request"}},[e._v("#")]),e._v(" Step 2. Send a request")]),e._v(" "),a("ol",[a("li",[a("p",[e._v("Use the "),a("RouterLink",{attrs:{to:"/master/connecting/clitools.html"}},[a("code",[e._v("immuclient")])]),e._v(" command to commit a transaction on the primary server:")],1),e._v(" "),a("p",[e._v("Login to immudb")]),e._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[e._v("$ ./immuclient login immudb\n")])])]),a("p",[e._v("Select database")]),e._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[e._v("$ ./immuclient use primarydb\n")])])]),a("p",[e._v("Set a value")]),e._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[e._v("$ ./immuclient safeset foo bar\n")])])])]),e._v(" "),a("li",[a("p",[e._v("Verify the transaction on the replica server using the "),a("RouterLink",{attrs:{to:"/master/connecting/clitools.html"}},[a("code",[e._v("immuclient")])]),e._v(" command:")],1),e._v(" "),a("p",[e._v("Login to immudb")]),e._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[e._v("$ ./immuclient login immudb -p "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("3324")]),e._v("\n")])])]),a("p",[e._v("Select database")]),e._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[e._v("$ ./immuclient use primarydb -p "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("3324")]),e._v("\n")])])]),a("p",[e._v("Verify the key")]),e._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[e._v("$ ./immuclient safeget foo -p "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("3324")]),e._v("\n")])])])])]),e._v(" "),a("h4",{attrs:{id:"step-3-stop-the-replica-server"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#step-3-stop-the-replica-server"}},[e._v("#")]),e._v(" Step 3. Stop the replica server")]),e._v(" "),a("ol",[a("li",[a("p",[e._v("Stop the replica server running on port 3325")])]),e._v(" "),a("li",[a("p",[e._v("Send a transaction to the primary server:")]),e._v(" "),a("p",[e._v("Login to immudb")]),e._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[e._v("$ ./immuclient login immudb\n")])])]),a("p",[e._v("Select database")]),e._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[e._v("$ ./immuclient use primarydb\n")])])]),a("p",[e._v("Set a value")]),e._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[e._v("$ ./immuclient safeset foo bar\n")])])]),a("p",[e._v("The client will block. This is because the primarydb requires 1 sync follower, and since the replica server is down, there is no ack from the replica server, hence synchronous transaction is blocked.")])])])])],1)}),[],!1,null,null,null);t.default=r.exports}}]);